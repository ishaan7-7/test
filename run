import pandas as pd
import os

# ==========================================
# 1. Configuration & Setup
# ==========================================

# Your base directory path
BASE_DIR = r"C:\static_inference\synthesis_data_40days\data\output"

# Define the modules to process
MODULES = ['body', 'battery', 'engine', 'transmission', 'tyre']

# Define where you want to save the final master CSVs
# (Currently saving to the parent of the output folder, or change as needed)
OUTPUT_SAVE_DIR = r"C:\static_inference\synthesis_data_40days\data\master_output"

if not os.path.exists(OUTPUT_SAVE_DIR):
    os.makedirs(OUTPUT_SAVE_DIR)

# ==========================================
# 2. Helper Functions
# ==========================================

def get_sim_folders(base_path):
    """Retrieves a sorted list of sim folders (e.g., sim001, sim002)."""
    return sorted([
        f for f in os.listdir(base_path) 
        if f.startswith('sim') and os.path.isdir(os.path.join(base_path, f))
    ])

def construct_filename(module, sim_id):
    """Generates the filename based on the provided pattern."""
    # Pattern: synthetic_{module}_inference_scenarioA_{sim_id}.csv
    return f"synthetic_{module}_inference_scenarioA_{sim_id}.csv"

# ==========================================
# 3. Main Processing Loop
# ==========================================

sim_folders = get_sim_folders(BASE_DIR)
print(f"Found {len(sim_folders)} simulation folders: {sim_folders[:5]} ...")

# Columns that must match across all files
REF_COLS = ['timestamp', 'timestamp_parsed', 'com_kms'] 

for module in MODULES:
    print(f"\nProcessing Module: {module.upper()}...")
    
    # This will hold our consolidated data for the current module
    master_df = None
    
    for sim_id in sim_folders:
        csv_name = construct_filename(module, sim_id)
        file_path = os.path.join(BASE_DIR, sim_id, csv_name)
        
        # Check if file exists
        if not os.path.exists(file_path):
            print(f"Warning: File missing for {sim_id} in module {module}. Skipping.")
            continue
            
        # Read the CSV
        # We only read the cols we need to save memory/time
        cols_to_read = REF_COLS + ['composite_score']
        current_df = pd.read_csv(file_path, usecols=cols_to_read)
        
        # Rename the score column immediately to the sim-specific name
        sim_score_col = f"{sim_id}_composite_score"
        current_df.rename(columns={'composite_score': sim_score_col}, inplace=True)
        
        if master_df is None:
            # First simulation: Initialize the master DataFrame
            master_df = current_df
        else:
            # VALIDATION: Check if reference columns match exactly
            # We compare the reference columns of the current master against the new file
            # Note: This assumes row ordering is identical (row 1 is same timestamp in both).
            
            # Extract reference data for comparison
            ref_check_master = master_df[REF_COLS]
            ref_check_current = current_df[REF_COLS]
            
            try:
                pd.testing.assert_frame_equal(ref_check_master, ref_check_current)
            except AssertionError:
                print(f"CRITICAL ERROR: Data mismatch found in {sim_id} for module {module}.")
                print("Timestamps or com_kms do not align with previous simulations.")
                # You might want to 'break' here or handle differently
                break
            
            # If validation passes, append only the score column to master_df
            # Since we validated the rows align, we can just assign the column
            master_df[sim_score_col] = current_df[sim_score_col]

    # ==========================================
    # 4. Save Master CSV for Module
    # ==========================================
    if master_df is not None:
        save_path = os.path.join(OUTPUT_SAVE_DIR, f"master_{module}.csv")
        master_df.to_csv(save_path, index=False)
        print(f"Saved master file: {save_path}")
        print(f"Final columns: {list(master_df.columns)[:5]} ...")

print("\nAll processing complete.")
