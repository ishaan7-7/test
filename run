import os
import sys
import time
import socket
import subprocess
from pathlib import Path

# --- Configuration ---
ROOT_DIR = Path(__file__).parent.resolve()
VENV_SCRIPTS = ROOT_DIR / ".venv" / "Scripts"

ZOOKEEPER_BAT = ROOT_DIR / "tools" / "kafka" / "start_zookeeper.bat"
KAFKA_BAT = ROOT_DIR / "tools" / "kafka" / "start_kafka.bat"

# Service Definitions
SERVICES = {
    "ingest": {
        "port": 8000,
        "cmd": "uvicorn ingest.app.main:app --port 8000 --reload"
    },
    "kafka_metrics": {
        "port": 9201,
        "cmd": "uvicorn kafka_metrics.app.main:app --port 9201 --reload"
    },
    "dashboard": {
        "port": 9300,
        "cmd": "uvicorn dashboard.app.main:app --port 9300 --reload"
    }
}

def print_step(msg):
    print(f"\n[STEP] {msg}")

def print_status(msg, status="INFO"):
    print(f"   [{status}] {msg}")

def check_port(port, host="127.0.0.1", timeout=1.0):
    """Checks if a port is open."""
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.settimeout(timeout)
        result = s.connect_ex((host, port))
        return result == 0

def wait_for_port(port, service_name, retries=30, delay=1):
    """Waits until a port is open."""
    print_status(f"Waiting for {service_name} on port {port}...", "WAIT")
    for _ in range(retries):
        if check_port(port):
            print_status(f"{service_name} is listening on port {port}.", "OK")
            return True
        time.sleep(delay)
    print_status(f"Timed out waiting for {service_name}.", "ERROR")
    return False

def start_new_window(command, title="Service"):
    """Starts a command in a completely new CMD window."""
    # subprocess.CREATE_NEW_CONSOLE is Windows-specific
    try:
        subprocess.Popen(
            f'start "{title}" {command}', 
            shell=True, 
            creationflags=subprocess.CREATE_NEW_CONSOLE
        )
        return True
    except Exception as e:
        print_status(f"Failed to launch window: {e}", "ERROR")
        return False

def activate_venv():
    """Injects venv scripts into PATH for this process and children."""
    if not VENV_SCRIPTS.exists():
        print_status("Virtual environment not found at .venv\\Scripts", "ERROR")
        return False
    
    # Prepend venv scripts to PATH
    os.environ["PATH"] = str(VENV_SCRIPTS) + os.pathsep + os.environ["PATH"]
    return True

def ask_user(prompt):
    """Simple y/n input."""
    while True:
        choice = input(f"\n> {prompt} (y/n): ").strip().lower()
        if choice in ['y', 'yes']:
            return True
        if choice in ['n', 'no']:
            return False

def main():
    print("========================================")
    print("   Streaming Emulator - Master Runner   ")
    print("========================================")

    # 1. Activate .venv
    if ask_user("Activate .venv"):
        if activate_venv():
            print_status(".venv activated (injected into process PATH).", "OK")
        else:
            sys.exit(1)
    else:
        print_status("Activation required to proceed.", "WARN")
        sys.exit(0)

    # 2. Start Zookeeper
    if ask_user("Start Zookeeper"):
        if not ZOOKEEPER_BAT.exists():
            print_status(f"Missing file: {ZOOKEEPER_BAT}", "ERROR")
        else:
            start_new_window(f'"{ZOOKEEPER_BAT}"', title="Zookeeper")
            # Wait for port 2181
            if wait_for_port(2181, "Zookeeper", retries=30):
                print_status("Stabilizing Zookeeper (waiting 10s)...", "WAIT")
                time.sleep(10)
                print_status("Zookeeper Ready.", "OK")
            else:
                print_status("Zookeeper did not start correctly.", "WARN")

    # 3. Start Kafka
    # Only verify Zookeeper is running before asking for Kafka
    if check_port(2181): 
        if ask_user("Start Kafka"):
            if not KAFKA_BAT.exists():
                print_status(f"Missing file: {KAFKA_BAT}", "ERROR")
            else:
                start_new_window(f'"{KAFKA_BAT}"', title="Kafka")
                if wait_for_port(9092, "Kafka", retries=60):
                    print_status("Kafka is Running successfully.", "OK")
    else:
        print_status("Skipping Kafka (Zookeeper port 2181 not open).", "SKIP")

    # 4. Start Python Services
    app_list = list(SERVICES.keys())
    print(f"\nAvailable Apps: {app_list}")
    
    start_all = ask_user("Start all apps")
    
    if start_all:
        for name, config in SERVICES.items():
            print_status(f"Launching {name}...", "INFO")
            start_new_window(config['cmd'], title=name)
            wait_for_port(config['port'], name)
    else:
        while True:
            selection = input(f"\nEnter app name from list (or 'exit'): ").strip().lower()
            if selection == 'exit':
                break
            
            if selection in SERVICES:
                config = SERVICES[selection]
                # Check if already running
                if check_port(config['port']):
                    print_status(f"{selection} is already running on port {config['port']}.", "WARN")
                else:
                    start_new_window(config['cmd'], title=selection)
                    wait_for_port(config['port'], selection)
            else:
                print_status("Invalid app name.", "WARN")

    print("\nAll tasks completed. You may close this launcher.")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nExiting...")
