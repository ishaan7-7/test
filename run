# File: C:\streaming_emulator\writer_service\verify_step2.py
import sys
from pathlib import Path

# Setup Path to import src modules
src_path = Path(__file__).parent / "src"
sys.path.append(str(src_path))

# Import the code we just wrote
try:
    import infrastructure
    import schema_loader
except ImportError as e:
    print(f"‚ùå Import Error: {e}")
    sys.exit(1)

print("‚è≥ Initializing Infrastructure (required for Spark types)...")
infrastructure.setup_environment()

print("\n‚è≥ Testing Dynamic Schema Generation...")
try:
    # Load Schemas
    schemas = schema_loader.load_all_schemas()
    
    # CHECK 1: Do we have all modules?
    expected_modules = ["engine", "battery", "transmission", "tyre", "body"]
    missing = [m for m in expected_modules if m not in schemas]
    
    if missing:
        print(f"‚ùå FAILED: Missing schemas for: {missing}")
        sys.exit(1)
    else:
        print(f"‚úÖ All {len(schemas)} modules loaded.")

    # CHECK 2: Validate 'Engine' Structure
    engine_schema = schemas['engine']
    print("\nüîç Inspecting 'Engine' Schema Structure:")
    
    # We expect 'metadata' and 'data' at the root
    field_names = engine_schema.names
    if "metadata" in field_names and "data" in field_names:
        print("   ‚úÖ Root structure correct (metadata + data)")
    else:
        print(f"   ‚ùå Root structure incorrect. Found: {field_names}")
        sys.exit(1)

    # CHECK 3: Metadata Timestamp Check
    meta_struct = engine_schema["metadata"].dataType
    if "ingest_ts" in meta_struct.names:
        print("   ‚úÖ Metadata includes 'ingest_ts' (Latency tracking enabled)")
    else:
        print("   ‚ùå Metadata MISSING 'ingest_ts'")
        sys.exit(1)

    # CHECK 4: Data Type Mapping Check
    # Let's peek at the 'data' struct
    data_struct = engine_schema["data"].dataType
    print(f"   ‚úÖ Mapped {len(data_struct.names)} data fields from master.json")
    
    # Print the full tree for visual confirmation
    print("\nExample Schema Tree (Engine):")
    engine_schema.printTreeString()
    
    print("\nüöÄ STEP 2 COMPLETE: Schema Engine is robust and ready.")

except Exception as e:
    print(f"\n‚ùå CRITICAL FAILURE: {e}")
    import traceback
    traceback.print_exc()
